<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Check-In</title>
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Noto Sans Myanmar', 'Inter', sans-serif;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Card Container -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-8 py-10 text-center">
                <div class="text-6xl mb-4">📋</div>
                <h1 class="text-3xl font-bold text-white mb-2">ဝန်ထမ်း အချိန်မှတ် စနစ်</h1>
                <p class="text-blue-100 text-sm">အဝင်/အထွက် ပြုလုပ်ရန် အောက်ပါခလုတ်ကို နှိပ်ပါ။</p>
            </div>

            <!-- Content -->
            <div class="px-8 py-10">
                <!-- Status Messages -->
                <div id="statusContainer" class="mb-6 hidden fade-in">
                    <div id="statusMessage" class="p-4 rounded-xl text-center font-medium"></div>
                </div>

                <!-- Current Session Status -->
                <div id="currentSessionStatus"
                    class="mb-6 p-4 rounded-xl text-center font-medium bg-gray-100 text-gray-500 fade-in hidden">
                    အခြေအနေ စစ်ဆေးနေပါသည်...
                </div>

                <!-- GPS Status -->
                <div id="gpsStatus" class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div id="gpsIcon" class="text-2xl pulse">📍</div>
                            <div>
                                <div class="text-sm font-semibold text-gray-700">တည်နေရာ အခြေအနေ</div>
                                <div id="gpsText" class="text-xs text-gray-500">တည်နေရာ ရှာဖွေနေပါသည်...</div>
                            </div>
                        </div>
                        <div id="gpsSpinner" class="animate-spin text-2xl">⏳</div>
                        <div id="gpsCheck" class="text-2xl hidden">✅</div>
                    </div>
                </div>

                <!-- Device ID Info -->
                <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <div class="text-xs font-semibold text-blue-700 mb-1">သင့် စက်ပစ္စည်း ID</div>
                    <div id="deviceIdDisplay" class="text-xs font-mono text-blue-600 break-all">Generating...</div>
                </div>

                <!-- Attendance Button -->
                <button id="attendanceBtn" disabled
                    class="w-full py-5 px-6 rounded-2xl font-bold text-lg shadow-lg transform transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white hover:shadow-xl hover:scale-105 active:scale-95">
                    <span id="btnText">🔒 GPS စောင့်ဆိုင်းနေသည်...</span>
                </button>

                <!-- Instructions -->
                <div class="mt-8 space-y-2">
                    <div class="flex items-start space-x-3 text-sm text-gray-600">
                        <span class="text-lg">1️⃣</span>
                        <p>တည်နေရာ အသုံးပြုခွင့် တောင်းဆိုပါက ခွင့်ပြုပေးပါ</p>
                    </div>
                    <div class="flex items-start space-x-3 text-sm text-gray-600">
                        <span class="text-lg">2️⃣</span>
                        <p>သတ်မှတ်ထားသော ဧရိယာအတွင်း ရှိနေကြောင်း သေချာပါစေ</p>
                    </div>
                    <div class="flex items-start space-x-3 text-sm text-gray-600">
                        <span class="text-lg">3️⃣</span>
                        <p>အဝင်/အထွက် အချိန်ကို မှတ်တမ်းတင်ရန် ခလုတ်ကို နှိပ်ပါ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6 text-xs text-gray-500">
            <p>Powered by Headless Attendance System</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://oceanviewtreasure.com/at/api.php';

        let deviceId = null;
        let userLocation = null;
        let isCheckedIn = false;
        let hasWorkedToday = false;
        let checkInTime = '';
        let workedDuration = '';
        let timerInterval = null;

        function updateButtonState() {
            const btnText = document.getElementById('btnText');
            if (!userLocation) {
                btnText.textContent = '🔒 GPS စောင့်ဆိုင်းနေသည်...';
            } else {
                if (isCheckedIn) {
                    btnText.textContent = '👋 အလုပ်ဆင်းမည် (Check Out)';
                } else if (hasWorkedToday) {
                    btnText.textContent = '✅ ထပ်မံ အလုပ်ဝင်မည် (Re-Check In)';
                } else {
                    btnText.textContent = '✅ အလုပ်ဝင်မည် (Check In)';
                }
            }
        }

        function initDeviceId() {
            deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem('device_id', deviceId);
            }
            document.getElementById('deviceIdDisplay').textContent = deviceId;
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showStatus('error', 'သင့်စက်ပစ္စည်းတွင် GPS တည်နေရာ အသုံးပြုခွင့် မရှိပါ။');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    document.getElementById('gpsSpinner').classList.add('hidden');
                    document.getElementById('gpsCheck').classList.remove('hidden');
                    document.getElementById('gpsIcon').classList.remove('pulse');
                    document.getElementById('gpsText').textContent = `တည်နေရာ ရရှိပါပြီ (±${Math.round(position.coords.accuracy)}m)`;

                    const btn = document.getElementById('attendanceBtn');
                    btn.disabled = false;
                    updateButtonState();
                },
                (error) => {
                    let message = 'တည်နေရာ ရှာမတွေ့ပါ။ ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'ကျေးဇူးပြု၍ Location ဖွင့်ပေးပါ။';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'တည်နေရာ အချက်အလက် မရရှိနိုင်ပါ။';
                            break;
                        case error.TIMEOUT:
                            message += 'အချိန်ကြာမြင့်နေပါသည်။ ပြန်လည် ကြိုးစားပါ။';
                            break;
                    }

                    document.getElementById('gpsSpinner').classList.add('hidden');
                    document.getElementById('gpsIcon').textContent = '❌';
                    document.getElementById('gpsIcon').classList.remove('pulse');
                    document.getElementById('gpsText').textContent = message;
                    showStatus('error', message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        async function submitAttendance() {
            if (!userLocation) {
                showStatus('error', 'တည်နေရာ မရရှိပါ။ ကျေးဇူးပြု၍ GPS ဖွင့်ပါ။');
                return;
            }

            const btn = document.getElementById('attendanceBtn');
            btn.disabled = true;
            document.getElementById('btnText').textContent = '⏳ ဆောင်ရွက်နေသည်...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        latitude: userLocation.latitude,
                        longitude: userLocation.longitude,
                        staff_name: 'Staff Member'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.data.type === 'IN') {
                        showStatus('success', `✅ Check In Successful!\n${data.data.check_in_time}`);
                    } else if (data.data.type === 'OUT') {
                        showStatus('info', `👋 Check Out Successful!\nDuration: ${data.data.duration || 'N/A'}`);
                    }
                    checkCurrentStatus();
                } else {
                    showStatus('error', `❌ ${data.message}`);
                }

            } catch (error) {
                showStatus('error', `❌ အင်တာနက် လိုင်းမကောင်းပါ။ ကျေးဇူးပြု၍ စစ်ဆေးပါ။\n${error.message}`);
            } finally {
                setTimeout(() => {
                    btn.disabled = false;
                    updateButtonState();
                }, 3000);
            }
        }

        async function checkCurrentStatus() {
            try {
                const response = await fetch(`${API_URL}?device_id=${deviceId}`);
                const data = await response.json();

                const statusDiv = document.getElementById('currentSessionStatus');

                statusDiv.classList.remove('hidden');

                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                if (data.success && data.data.is_checked_in) {
                    isCheckedIn = true;
                    hasWorkedToday = false;
                    statusDiv.className = 'mb-6 p-4 rounded-xl text-center font-medium bg-green-100 text-green-800 border border-green-200 fade-in';

                    const startTimestamp = data.data.check_in_timestamp;

                    const updateTimer = () => {
                        const now = Math.floor(Date.now() / 1000);
                        let diff = now - startTimestamp;
                        const hours = Math.floor(diff / 3600);
                        diff %= 3600;
                        const minutes = Math.floor(diff / 60);
                        const seconds = diff % 60;

                        let timeStr = '';
                        if (hours > 0) timeStr += hours + 'h ';
                        timeStr += minutes + 'm ' + seconds + 's';

                        statusDiv.textContent = `🟢 အလုပ်ဝင်နေပါသည် (${data.data.check_in_time} မှစ၍) ⏱️ ${timeStr}`;
                    };

                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);

                } else if (data.success && data.data.has_worked_today) {
                    isCheckedIn = false;
                    hasWorkedToday = true;
                    statusDiv.className = 'mb-6 p-4 rounded-xl text-center font-medium bg-blue-100 text-blue-800 border border-blue-200 fade-in';
                    statusDiv.textContent = `✅ ယနေ့ အလုပ်ဆင်းပြီးပါပြီ (${data.data.worked_duration})`;
                } else {
                    isCheckedIn = false;
                    hasWorkedToday = false;
                    statusDiv.className = 'mb-6 p-4 rounded-xl text-center font-medium bg-gray-100 text-gray-600 border border-gray-200 fade-in';
                    statusDiv.textContent = `⚪ အလုပ်မဝင်ရသေးပါ`;
                }

                updateButtonState();
            } catch (error) {
                console.error("Status check failed:", error);
            }
        }

        function showStatus(type, message) {
            const container = document.getElementById('statusContainer');
            const msgDiv = document.getElementById('statusMessage');

            container.classList.remove('hidden');
            msgDiv.className = 'p-4 rounded-xl text-center font-medium fade-in';

            if (type === 'success') {
                msgDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
            } else if (type === 'info') {
                msgDiv.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
            } else {
                msgDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
            }

            msgDiv.textContent = message;

            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }

        document.getElementById('attendanceBtn').addEventListener('click', submitAttendance);

        window.addEventListener('load', async () => {
            initDeviceId();
            await checkCurrentStatus();
            requestLocation();
        });
    </script>
</body>

</html>